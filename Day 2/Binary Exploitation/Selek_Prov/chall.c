#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>
// gcc ./chall.c -o chall -fstack-protector-all

#define MAX_DESTINATIONS 6
#define MAX_ROUTE_LENGTH 96

// Struct to hold destination information
typedef struct {
    char name[32];
    char route[MAX_ROUTE_LENGTH];
} Destination;

Destination destinations[MAX_DESTINATIONS] = {
    {"Home", "Start at your location, take the first left, and continue for 2 miles."},
    {"Work", "Start at your location, take the second right, and continue for 5 miles."},
    {"School", "Start at your location, head straight for 3 miles, then take a left."},
    {"Mall", "Start at your location, take the first right, then a left, and continue for 4 miles."},
    {"Park", "Start at your location, head straight for 1 mile, then take a left."},
    {"FLAG{fake_flag}","FLAG{fake_flag}"}
};

// Function prototypes
void displayMenu();
void displayDestinations();
void findRoute();
void editRoute();

void hehe(){
    FILE *f = fopen("./flag.txt", "r");
    if (f == NULL) {
        printf("Cannot open flag.txt\n");
        exit(1);
    }
    fgets(destinations[6-1].name, 32, f);
    fgets(destinations[6-1].route, MAX_ROUTE_LENGTH, f);
    fclose(f);
}

int readint(){
    char buf[0x10];
    return atoi(fgets(buf,0x10,stdin));
}

void init()
{
    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);
    setvbuf(stderr, 0, 2, 0);
    alarm(60);
    hehe();
}

int main() {
    init();

    int choice;
    
    do {
        displayMenu();
        printf("Enter your choice: ");
        choice = readint();
        
        switch(choice) {
            case 1:
                displayDestinations();
                break;
            case 2:
                findRoute();
                break;
            case 3:
                editRoute();
                break;
            case 4:
                printf("Exiting the program.\n");
                break;
            default:
                printf("Invalid choice. Please try again.\n");
        }
    } while (choice != 4);
    
    return 0;
}

void displayMenu() {
    printf("\nCar Navigation System\n");
    printf("1. Display all destinations\n");
    printf("2. Find route to a destination\n");
    printf("3. Edit route to a destination\n");
    printf("4. Exit\n");
}

void displayDestinations() {
    printf("Available destinations:\n");
    for (int i = 0; i < MAX_DESTINATIONS-1; i++) {
        printf("%d. %s\n", i + 1, destinations[i].name);
    }
}

void findRoute() {
    int choice;
    displayDestinations();
    printf("Enter the number of your destination: ");
    choice = readint();
    
    if (choice < 1 || choice > MAX_DESTINATIONS-1) {
        printf("Invalid destination number. Please try again.\n");
    } else {
        printf("Route to %s:\n", destinations[choice - 1].name);
        printf("%s\n", destinations[choice - 1].route);
    }
}

void editRoute() {
    int choice;

    displayDestinations();
    printf("Enter the number of the destination you want to edit: ");
    choice = readint();

    if (choice < 1 || choice > MAX_DESTINATIONS-1) {
        printf("Invalid destination number. Please try again.\n");
    } else {
        printf("Enter the new route for %s: ", destinations[choice - 1].name);
        read(0,destinations[choice - 1].route, MAX_ROUTE_LENGTH);

        printf("Route to %s has been updated.\n", destinations[choice - 1].name);
    }
}